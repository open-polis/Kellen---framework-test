# .github/workflows/ci-cd.yml
# -----------------------------------------------------------------------------
# CI/CD pipeline for a **Next.js** project deployed to Vercel
# -----------------------------------------------------------------------------
# â€¢ **Lint** every Pull Request (PR) with ESLint so contributors catch issues
#   early.
# â€¢ **Deploy** to Vercel **only when** changes land in the `master` branch **and**
#   the lint job passes.
#
#  âœ‹ðŸ½  PREâ€‘REQUISITES
#  ---------------------------------------------------------------------------
#  1. Generate a Vercel **access token** (Account â†’ Settings â†’ Tokens) and add
#     it to your GitHub repository secrets as `VERCEL_TOKEN`.
#  2. Locate your **org** and **project** IDs (run `npx vercel link` locally or
#     open the `.vercel/project.json` file) and add them as secrets:
#        â€¢ `VERCEL_ORG_ID`
#        â€¢ `VERCEL_PROJECT_ID`
#  3. Disable Vercelâ€™s automatic Git deployments (via *vercel.json* or the
#     dashboard) so deployment happens *only* from this workflow.
#  4. Ensure `npm run lint` exits with nonâ€‘zero on problems.
# -----------------------------------------------------------------------------
#  ðŸ—“ï¸  Updated: 2025â€‘07â€‘04 â€“ caching removed for simplicity

name: CI/CD â€“ Vercel

# -----------------------------------------------------------------------------
# 1ï¸âƒ£  EVENT TRIGGERS
# -----------------------------------------------------------------------------
# â€¢ On **pull_request** â†’ run the *lint* job.
# â€¢ On **push** to `master` â†’ run *lint* and, if it succeeds, *deploy*.
# -----------------------------------------------------------------------------
on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [master]

# Cancel redundant runs on the same branch/PR.
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# -----------------------------------------------------------------------------
# 2ï¸âƒ£  JOB: LINT â€“ ESLint check (runs for both triggers)
# -----------------------------------------------------------------------------
jobs:
  lint:
    name: "ðŸ’… ESLint"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint
        run: npm run lint

  # ---------------------------------------------------------------------------
  # 3ï¸âƒ£  JOB: DEPLOY â€“ production deploy via Vercel CLI
  #    â€¢ only fires on pushâ†’master  **and**  if lint passed
  # ---------------------------------------------------------------------------
  deploy:
    name: "ðŸš€ Deploy to Vercel (production)"
    needs: lint
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest
    environment:
      name: production
      url: ${{ steps.deploy.outputs.deployment_url || '' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Use Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Install dependencies (skips postinstall scripts for speed; optional)
      - name: Install dependencies
        run: npm ci --ignore-scripts

      # --- Deployment ---
      - name: Deploy with Vercel CLI
        id: deploy
        run: |
          npx vercel --prod \
            --token "${{ secrets.VERCEL_TOKEN }}" \
            --scope "${{ secrets.VERCEL_ORG_ID }}" \
            --confirm
          echo "deployment_url=$(vercel inspect --token ${{ secrets.VERCEL_TOKEN }} --scope ${{ secrets.VERCEL_ORG_ID }} | grep -m1 'https')" >> $GITHUB_OUTPUT

      - name: Echo deployment URL
        run: echo "Deployed to ${{ steps.deploy.outputs.deployment_url }}"